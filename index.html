<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rhino XR-4 – Virtual Teach Pendant</title>
  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --accent: #38bdf8;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --on: #22c55e;
      --off: #4b5563;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: radial-gradient(circle at top, #0b1120 0, #020617 45%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .page {
      max-width: 1100px;
      width: 100%;
      padding: 18px 18px 26px;
    }

    header h1 {
      margin: 0 0 4px;
      font-size: 1.7rem;
    }

    header h1 span {
      color: var(--accent);
    }

    header p {
      margin: 0 0 10px;
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .layout {
      display: grid;
      grid-template-columns: 1.2fr 1.1fr;
      gap: 14px;
    }

    .card {
      background: linear-gradient(145deg, var(--card), #020617);
      border-radius: 14px;
      border: 1px solid #1f2937;
      padding: 12px 14px;
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.45);
    }

    .card-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    canvas {
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #020617 100%);
      border-radius: 10px;
      border: 1px solid #111827;
      display: block;
      margin: 0 auto;
    }

    .info-bar {
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .info-bar span strong {
      color: var(--text-main);
    }

    /* Teach pendant styles */
    .pendant-grid {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 10px;
    }

    .section-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .safe-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    button {
      font-family: inherit;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text-main);
      font-size: 0.75rem;
      padding: 4px 8px;
      cursor: pointer;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn-main {
      background: #0f172a;
      border-color: var(--accent);
    }

    .btn-danger {
      border-color: #f97373;
      color: #fecaca;
    }

    .btn-safe {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      border: 1px solid #16a34a;
      background: #022c22;
      color: #bbf7d0;
    }

    .btn-safe.off {
      border-color: #b91c1c;
      background: #450a0a;
      color: #fecaca;
    }

    .mode-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .mode-row .btn {
      font-size: 0.75rem;
      padding: 3px 8px;
    }

    .btn-mode-active {
      border-color: var(--accent);
      background: #0b1120;
      color: var(--text-main);
    }

    .jog-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
    }

    .jog-block {
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 6px 6px 8px;
      background: #020617;
      font-size: 0.8rem;
    }

    .jog-block-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-main);
    }

    .btn-jog-row {
      display: flex;
      gap: 4px;
    }

    .teach-controls {
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 6px 8px 8px;
      background: #020617;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .teach-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .poses-list {
      margin-top: 4px;
      max-height: 170px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px dashed #1f2937;
      padding: 4px 4px 4px;
      font-size: 0.78rem;
    }

    .pose-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 3px 4px;
      border-radius: 6px;
      cursor: default;
    }

    .pose-item:nth-child(odd) {
      background: rgba(15, 23, 42, 0.6);
    }

    .pose-item span.name {
      font-weight: 600;
      color: var(--accent);
    }

    .pose-item span.details {
      color: var(--text-soft);
      font-size: 0.75rem;
    }

    .play-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .play-row label {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .play-row input[type="range"] {
      flex: 1;
    }

    .tiny {
      font-size: 0.75rem;
      color: var(--text-soft);
      margin-top: 4px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Rhino XR-4 – <span>Virtual Teach Pendant</span></h1>
      <p>
        Simple 2D visualization of a Rhino-style arm (3 joints) with a teach pendant.
        Jog joints (articulate), try linear TCP moves, teach positions, set a Soft Home, and grasp a target object.
      </p>
    </header>

    <div class="layout">
      <!-- Left: Visualization -->
      <section class="card">
        <div class="card-title">Robot View (Planar Workspace)</div>
        <canvas id="robotCanvas" width="420" height="320"></canvas>
        <div class="info-bar">
          <span>Joints:
            <strong><span id="j1-val">0</span>°</strong>,
            <strong><span id="j2-val">0</span>°</strong>,
            <strong><span id="j3-val">0</span>°</strong>
          </span>
          <span>TCP:
            <strong>X = <span id="x-val">0.0</span></strong>,
            <strong>Y = <span id="y-val">0.0</span></strong>
          </span>
          <span>Target:
            <strong>X = <span id="target-x">0.0</span></strong>,
            <strong>Y = <span id="target-y">0.0</span></strong>,
            <strong>Status: <span id="target-status">Free</span></strong>
          </span>
        </div>
        <div class="tiny">
          Workspace rings show approximate reach of the arm. Yellow dot = end-effector; magenta square = target object.
          If you close the gripper near the target, it is considered “grasped” and moves with the TCP.
        </div>
      </section>

      <!-- Right: Teach Pendant -->
      <section class="card">
        <div class="card-title">Teach Pendant (Virtual)</div>

        <!-- SAFE -->
        <div class="safe-row">
          <span style="font-size:0.8rem;">Teach Pendant Safe (Enabling)</span>
          <button class="btn-safe" id="btn-safe">SAFE: ON</button>
        </div>
        <div class="tiny">
          When SAFE is OFF, jogging, teaching and playback are disabled – like a deadman/enabling switch.
        </div>

        <div class="pendant-grid" style="margin-top:8px;">
          <!-- Jog area -->
          <div>
            <div class="section-label">Jog mode</div>

            <div class="mode-row">
              <span>Mode:</span>
              <button class="btn btn-mode-active" id="mode-joint">Articulate (Joint)</button>
              <button class="btn" id="mode-linear">Linear (TCP X/Y)</button>
            </div>

            <!-- Joint jog panel -->
            <div id="joint-jog-panel">
              <div class="jog-grid">
                <div class="jog-block">
                  <div class="jog-block-title">J1 (Base)</div>
                  <div class="btn-jog-row">
                    <button class="btn" data-jog="j1-" title="J1 -5°">J1 -</button>
                    <button class="btn" data-jog="j1+" title="J1 +5°">J1 +</button>
                  </div>
                </div>

                <div class="jog-block">
                  <div class="jog-block-title">J2 (Shoulder)</div>
                  <div class="btn-jog-row">
                    <button class="btn" data-jog="j2-" title="J2 -5°">J2 -</button>
                    <button class="btn" data-jog="j2+" title="J2 +5°">J2 +</button>
                  </div>
                </div>

                <div class="jog-block">
                  <div class="jog-block-title">J3 (Elbow)</div>
                  <div class="btn-jog-row">
                    <button class="btn" data-jog="j3-" title="J3 -5°">J3 -</button>
                    <button class="btn" data-jog="j3+" title="J3 +5°">J3 +</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Linear jog panel -->
            <div id="linear-jog-panel" style="display:none; margin-top:4px;">
              <div class="jog-block">
                <div class="jog-block-title">Linear TCP Jog (X/Y)</div>
                <div class="btn-jog-row">
                  <button class="btn" data-jogcart="x-">X -</button>
                  <button class="btn" data-jogcart="x+">X +</button>
                </div>
                <div class="btn-jog-row" style="margin-top:4px;">
                  <button class="btn" data-jogcart="y-">Y -</button>
                  <button class="btn" data-jogcart="y+">Y +</button>
                </div>
              </div>
            </div>

            <div style="margin-top: 6px; display:flex; gap:6px; flex-wrap:wrap;">
              <button class="btn btn-main" id="btn-home">Move to Home</button>
              <button class="btn" id="btn-set-soft-home">Set Soft Home</button>
              <button class="btn" id="btn-go-soft-home">Go to Soft Home</button>
              <button class="btn btn-danger" id="btn-clear">Clear All Poses</button>
            </div>

            <div class="tiny">
              Articulate mode = joint jog (J1, J2, J3). Linear mode = approximate straight-line motion of the TCP in X/Y
              using inverse kinematics steps. Soft Home can be set to any convenient, collision-free pose.
            </div>
          </div>

          <!-- Teach / Program area -->
          <div>
            <div class="section-label">Teach, Gripper & Program</div>
            <div class="teach-controls">
              <div class="teach-row">
                <span>Gripper / Object</span>
                <button class="btn btn-main" id="btn-grip">Gripper: OPEN</button>
              </div>
              <div class="tiny">
                Close the gripper when the TCP is near the target to “grasp” it. Open to release and drop at current TCP.
              </div>

              <div class="teach-row" style="margin-top:4px;">
                <span>Teach current pose</span>
                <button class="btn btn-main" id="btn-teach">Teach Position</button>
              </div>
              <div class="tiny">
                A new point P1, P2, … will be added with current joint angles and TCP coordinates.
              </div>

              <div class="section-label" style="margin-top:4px;">Taught Positions</div>
              <div class="poses-list" id="poses-list">
                <div class="tiny" id="no-poses">No poses yet. Jog the arm and click “Teach Position”.</div>
              </div>

              <div class="section-label" style="margin-top:4px;">Playback</div>
              <div class="play-row">
                <button class="btn btn-main" id="btn-play">Play Sequence</button>
                <label for="speed-range">Speed</label>
                <input type="range" id="speed-range" min="0.3" max="2.0" step="0.1" value="1.0" />
              </div>
              <div class="tiny">
                Playback uses articulate (joint-space) motion between taught poses. Students can compare that to linear
                X/Y jogging above.
              </div>
            </div>
          </div>
        </div>

        <div class="tiny" style="margin-top:8px;">
          This is a teaching aid only
        </div>
      </section>
    </div>

    <div class="tiny" style="margin-top:10px; border-top:1px dashed #4b5563; padding-top:6px;">
      Made by Hamza Sohail (DE - 40 MTS) – Virtual lab for teaching industrial robots, workspace, and teach pendant concepts.
    </div>
  </div>

  <script>
    /* ==============================
       Simple 3-DOF planar arm model
       ============================== */

    const canvas = document.getElementById("robotCanvas");
    const ctx = canvas.getContext("2d");

    // Link lengths in "pixels" (scaled, not real mm)
    const L1 = 120;
    const L2 = 90;
    const L3 = 70;

    // Base position
    const baseX = canvas.width / 2;
    const baseY = canvas.height - 40;

    // Joint angles in degrees
    let j1 = 0;
    let j2 = 30;
    let j3 = -60;

    // SAFE switch
    let safeEnabled = true;

    // Gripper & target
    let gripperClosed = false;
    const target = {
      x: baseX + 150,       // world coords
      y: baseY - 80,
      grasped: false
    };

    // Taught poses
    const poses = [];
    let poseCounter = 0;
    let isPlaying = false;
    let playTimeout = null;

    // Jog mode
    let jogMode = "joint"; // "joint" or "linear"

    // Soft Home pose (user-set)
    let softHomePose = null; // { j1, j2, j3 } when set

    function degToRad(d) {
      return d * Math.PI / 180;
    }

    function forwardKinematics(j1Deg, j2Deg, j3Deg) {
      const t1 = degToRad(j1Deg);
      const t2 = degToRad(j2Deg);
      const t3 = degToRad(j3Deg);

      const t12 = t1 + t2;
      const t123 = t1 + t2 + t3;

      const x1 = baseX + L1 * Math.cos(t1);
      const y1 = baseY - L1 * Math.sin(t1);

      const x2 = x1 + L2 * Math.cos(t12);
      const y2 = y1 - L2 * Math.sin(t12);

      const x3 = x2 + L3 * Math.cos(t123);
      const y3 = y2 - L3 * Math.sin(t123);

      return {
        joints: [
          { x: baseX, y: baseY },
          { x: x1, y: y1 },
          { x: x2, y: y2 },
          { x: x3, y: y3 }
        ],
        tcp: { x: x3, y: y3 }
      };
    }

    function getTCPRelative() {
      const { tcp } = forwardKinematics(j1, j2, j3);
      const xRel = tcp.x - baseX;
      const yRel = baseY - tcp.y; // positive upwards
      return { x: xRel, y: yRel };
    }

    function drawRobot() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw workspace (approx reachable area)
      const rOuter = L1 + L2 + L3 - 4;
      const rInner = Math.abs(L1 - (L2 + L3)) + 4;

      ctx.save();
      ctx.strokeStyle = "#1e293b";
      ctx.lineWidth = 1;
      // Grid
      for (let x = 20; x < canvas.width; x += 40) {
        ctx.beginPath();
        ctx.moveTo(x, 10);
        ctx.lineTo(x, canvas.height - 10);
        ctx.stroke();
      }
      for (let y = 20; y < canvas.height; y += 40) {
        ctx.beginPath();
        ctx.moveTo(10, y);
        ctx.lineTo(canvas.width - 10, y);
        ctx.stroke();
      }
      // Outer workspace ring
      ctx.strokeStyle = "rgba(148,163,184,0.7)";
      ctx.beginPath();
      ctx.arc(baseX, baseY, rOuter, 0, Math.PI * 2);
      ctx.stroke();
      // Inner workspace ring
      ctx.strokeStyle = "rgba(55,65,81,0.6)";
      ctx.beginPath();
      ctx.arc(baseX, baseY, rInner, 0, Math.PI * 2);
      ctx.stroke();
      ctx.restore();

      // Compute FK
      const { joints, tcp } = forwardKinematics(j1, j2, j3);

      // Draw links
      ctx.save();
      ctx.lineWidth = 8;
      ctx.lineCap = "round";

      ctx.strokeStyle = "#38bdf8";
      ctx.beginPath();
      ctx.moveTo(joints[0].x, joints[0].y);
      ctx.lineTo(joints[1].x, joints[1].y);
      ctx.stroke();

      ctx.strokeStyle = "#22c55e";
      ctx.beginPath();
      ctx.moveTo(joints[1].x, joints[1].y);
      ctx.lineTo(joints[2].x, joints[2].y);
      ctx.stroke();

      ctx.strokeStyle = "#f97316";
      ctx.beginPath();
      ctx.moveTo(joints[2].x, joints[2].y);
      ctx.lineTo(joints[3].x, joints[3].y);
      ctx.stroke();
      ctx.restore();

      // Draw joints
      ctx.save();
      ctx.fillStyle = "#020617";
      ctx.strokeStyle = "#e5e7eb";
      ctx.lineWidth = 2;
      joints.forEach((p, index) => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, index === 0 ? 9 : 6, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();
      });
      ctx.restore();

      // Draw TCP marker
      ctx.save();
      ctx.fillStyle = "#facc15";
      ctx.beginPath();
      ctx.arc(tcp.x, tcp.y, 5, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();

      // Draw target (object)
      ctx.save();
      let targetDrawX, targetDrawY;
      if (target.grasped) {
        targetDrawX = tcp.x;
        targetDrawY = tcp.y;
      } else {
        targetDrawX = target.x;
        targetDrawY = target.y;
      }
      ctx.translate(targetDrawX, targetDrawY);
      ctx.fillStyle = target.grasped ? "#22c55e" : "#e879f9";
      ctx.strokeStyle = "#0f172a";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.rect(-6, -6, 12, 12);
      ctx.fill();
      ctx.stroke();
      ctx.restore();

      // Update numeric displays
      document.getElementById("j1-val").textContent = j1.toFixed(1);
      document.getElementById("j2-val").textContent = j2.toFixed(1);
      document.getElementById("j3-val").textContent = j3.toFixed(1);

      const xRel = tcp.x - baseX;
      const yRel = baseY - tcp.y; // positive up
      document.getElementById("x-val").textContent = xRel.toFixed(1);
      document.getElementById("y-val").textContent = yRel.toFixed(1);

      // Target info (always relative to base)
      const targetRelX = (target.grasped ? tcp.x : target.x) - baseX;
      const targetRelY = baseY - (target.grasped ? tcp.y : target.y);
      document.getElementById("target-x").textContent = targetRelX.toFixed(1);
      document.getElementById("target-y").textContent = targetRelY.toFixed(1);

      let statusText = "Free";
      if (target.grasped) {
        statusText = "Grasped";
      } else {
        const dist = Math.hypot(target.x - tcp.x, target.y - tcp.y);
        if (dist < 15) {
          statusText = "Reachable (close enough to grasp)";
        }
      }
      document.getElementById("target-status").textContent = statusText;
    }

    /* ============ Jogging ============ */

    function clamp(val, min, max) {
      return Math.max(min, Math.min(max, val));
    }

    function jogJoint(jointName, deltaDeg) {
      if (!safeEnabled || jogMode !== "joint") return;

      if (jointName === "j1") j1 += deltaDeg;
      if (jointName === "j2") j2 += deltaDeg;
      if (jointName === "j3") j3 += deltaDeg;

      j1 = clamp(j1, -150, 150);
      j2 = clamp(j2, -90, 90);
      j3 = clamp(j3, -120, 120);

      drawRobot();
    }

    document.querySelectorAll("[data-jog]").forEach(btn => {
      btn.addEventListener("click", () => {
        const command = btn.getAttribute("data-jog");
        const joint = command.slice(0, 2); // "j1", "j2", ...
        const sign = command.slice(2);     // "+" or "-"
        const step = 5;
        jogJoint(joint, sign === "+" ? step : -step);
      });
    });

    /* ===== Improved linear (Cartesian) jog using IK pseudoinverse ===== */

    // IK step: move TCP towards (targetX, targetY) in relative coordinates
    function ikStepTowardsXY(targetX, targetY) {
      // targetX, targetY are TCP coordinates RELATIVE to base (xRel, yRel)
      const maxIter = 80;   // more iterations => more accurate
      for (let k = 0; k < maxIter; k++) {
        const { x, y } = getTCPRelative();  // current TCP (relative to base)
        const ex = targetX - x;
        const ey = targetY - y;
        const err = Math.hypot(ex, ey);
        if (err < 0.3) break;   // close enough

        const t1 = degToRad(j1);
        const t2 = degToRad(j2);
        const t3 = degToRad(j3);

        const s1 = Math.sin(t1),        c1 = Math.cos(t1);
        const s12 = Math.sin(t1 + t2),  c12 = Math.cos(t1 + t2);
        const s123 = Math.sin(t1 + t2 + t3), c123 = Math.cos(t1 + t2 + t3);

        // Jacobian columns d[x,y]/dθi
        const dx1 = -L1 * s1 - L2 * s12 - L3 * s123;
        const dx2 = -L2 * s12 - L3 * s123;
        const dx3 = -L3 * s123;

        const dy1 =  L1 * c1 + L2 * c12 + L3 * c123;
        const dy2 =  L2 * c12 + L3 * c123;
        const dy3 =  L3 * c123;

        // J is 2x3. Compute (J J^T + λ²I)^-1 for a damped pseudoinverse
        const j11 = dx1*dx1 + dx2*dx2 + dx3*dx3;
        const j12 = dx1*dy1 + dx2*dy2 + dx3*dy3;
        const j21 = j12;
        const j22 = dy1*dy1 + dy2*dy2 + dy3*dy3;

        const lambda2 = 1e-4;  // damping for stability
        const a = j11 + lambda2;
        const b = j12;
        const c = j21;
        const d = j22 + lambda2;

        const det = a*d - b*c;
        if (Math.abs(det) < 1e-8) break;  // singular: stop

        // (J J^T + λ²I)^-1
        const inv00 =  d / det;
        const inv01 = -b / det;
        const inv10 = -c / det;
        const inv11 =  a / det;

        // v = (J J^T + λ²I)^-1 * e   (2x2 * 2x1)
        const vx = inv00*ex + inv01*ey;
        const vy = inv10*ex + inv11*ey;

        // dθ = J^T v   (3x2 * 2x1)
        let dtheta1 = dx1*vx + dy1*vy;
        let dtheta2 = dx2*vx + dy2*vy;
        let dtheta3 = dx3*vx + dy3*vy;

        // scale down to avoid huge jumps
        const scale = 0.6;
        dtheta1 *= scale;
        dtheta2 *= scale;
        dtheta3 *= scale;

        j1 += dtheta1 * 180 / Math.PI;
        j2 += dtheta2 * 180 / Math.PI;
        j3 += dtheta3 * 180 / Math.PI;

        // joint limits
        j1 = clamp(j1, -150, 150);
        j2 = clamp(j2, -90, 90);
        j3 = clamp(j3, -120, 120);
      }
    }

    // Linear jog buttons: X+/X−, Y+/Y−
    document.querySelectorAll("[data-jogcart]").forEach(btn => {
      btn.addEventListener("click", () => {
        if (!safeEnabled || jogMode !== "linear") return;

        const cmd = btn.getAttribute("data-jogcart");
        const step = 10; // pixels in TCP space per click

        const { x, y } = getTCPRelative(); // current TCP (relative to base)
        let tx = x;
        let ty = y;

        if (cmd === "x+") tx += step;
        if (cmd === "x-") tx -= step;
        if (cmd === "y+") ty += step;
        if (cmd === "y-") ty -= step;

        // keep target inside approximate outer workspace
        const r = Math.hypot(tx, ty);
        const rMax = L1 + L2 + L3 - 10;
        if (r > rMax) {
          tx *= rMax / r;
          ty *= rMax / r;
        }

        // Solve IK towards this TCP target
        ikStepTowardsXY(tx, ty);
        drawRobot();
      });
    });

    document.getElementById("btn-home").addEventListener("click", () => {
      if (!safeEnabled) return;
      j1 = 0;
      j2 = 30;
      j3 = -60;
      drawRobot();
    });

    // Set Soft Home button
    const setSoftHomeBtn = document.getElementById("btn-set-soft-home");
    const goSoftHomeBtn = document.getElementById("btn-go-soft-home");

    setSoftHomeBtn.addEventListener("click", () => {
      if (!safeEnabled) return;
      softHomePose = { j1, j2, j3 };
      // give a small visual cue
      setSoftHomeBtn.textContent = "Soft Home Set";
      goSoftHomeBtn.textContent = "Go to Soft Home";
    });

    // Go to Soft Home button
    goSoftHomeBtn.addEventListener("click", () => {
      if (!safeEnabled) return;
      if (!softHomePose) {
        // if none set yet, do nothing or you can default:
        goSoftHomeBtn.textContent = "Soft Home Not Set";
        return;
      }
      j1 = softHomePose.j1;
      j2 = softHomePose.j2;
      j3 = softHomePose.j3;
      drawRobot();
    });

    /* ============ SAFE BUTTON ============ */
    const safeBtn = document.getElementById("btn-safe");
    safeBtn.addEventListener("click", () => {
      safeEnabled = !safeEnabled;
      safeBtn.classList.toggle("off", !safeEnabled);
      safeBtn.textContent = safeEnabled ? "SAFE: ON" : "SAFE: OFF";
      if (!safeEnabled) {
        // also stop playback if running
        stopPlayback();
      }
    });

    /* ============ Jog mode toggle ============ */
    const modeJointBtn = document.getElementById("mode-joint");
    const modeLinearBtn = document.getElementById("mode-linear");
    const jointPanel = document.getElementById("joint-jog-panel");
    const linearPanel = document.getElementById("linear-jog-panel");

    function setJogMode(mode) {
      jogMode = mode;
      if (mode === "joint") {
        jointPanel.style.display = "block";
        linearPanel.style.display = "none";
        modeJointBtn.classList.add("btn-mode-active");
        modeLinearBtn.classList.remove("btn-mode-active");
      } else {
        jointPanel.style.display = "none";
        linearPanel.style.display = "block";
        modeJointBtn.classList.remove("btn-mode-active");
        modeLinearBtn.classList.add("btn-mode-active");
      }
    }

    modeJointBtn.addEventListener("click", () => setJogMode("joint"));
    modeLinearBtn.addEventListener("click", () => setJogMode("linear"));

    /* ============ Gripper & target grasp ============ */
    const gripBtn = document.getElementById("btn-grip");
    gripBtn.addEventListener("click", () => {
      if (!safeEnabled) return;
      gripperClosed = !gripperClosed;
      if (gripperClosed) {
        // Try to grasp if close
        const { tcp } = forwardKinematics(j1, j2, j3);
        const dist = Math.hypot(target.x - tcp.x, target.y - tcp.y);
        if (!target.grasped && dist < 15) {
          target.grasped = true;
        }
        gripBtn.textContent = "Gripper: CLOSED";
        gripBtn.classList.add("btn-danger");
      } else {
        // Release if grasped
        if (target.grasped) {
          const { tcp } = forwardKinematics(j1, j2, j3);
          target.x = tcp.x;
          target.y = tcp.y;
          target.grasped = false;
        }
        gripBtn.textContent = "Gripper: OPEN";
        gripBtn.classList.remove("btn-danger");
      }
      drawRobot();
    });

    /* ============ Teaching poses ============ */
    const posesListEl = document.getElementById("poses-list");
    const noPosesEl = document.getElementById("no-poses");

    function renderPoses() {
      posesListEl.innerHTML = "";
      if (poses.length === 0) {
        posesListEl.appendChild(noPosesEl);
        noPosesEl.style.display = "block";
        return;
      }
      noPosesEl.style.display = "none";

      poses.forEach(p => {
        const div = document.createElement("div");
        div.className = "pose-item";
        const nameSpan = document.createElement("span");
        nameSpan.className = "name";
        nameSpan.textContent = p.name;

        const detailSpan = document.createElement("span");
        detailSpan.className = "details";
        detailSpan.textContent =
          `J1=${p.j1.toFixed(0)}°, J2=${p.j2.toFixed(0)}°, J3=${p.j3.toFixed(0)}° | X=${p.x.toFixed(0)}, Y=${p.y.toFixed(0)}`;

        div.appendChild(nameSpan);
        div.appendChild(detailSpan);

        // Clicking a pose jumps robot there (like "Go to pose")
        div.addEventListener("click", () => {
          if (!safeEnabled) return;
          j1 = p.j1;
          j2 = p.j2;
          j3 = p.j3;
          drawRobot();
        });

        posesListEl.appendChild(div);
      });
    }

    document.getElementById("btn-teach").addEventListener("click", () => {
      if (!safeEnabled) return;
      const { tcp } = forwardKinematics(j1, j2, j3);
      const xRel = tcp.x - baseX;
      const yRel = baseY - tcp.y;
      poseCounter++;
      const poseName = "P" + poseCounter;
      poses.push({
        name: poseName,
        j1: j1,
        j2: j2,
        j3: j3,
        x: xRel,
        y: yRel
      });
      renderPoses();
    });

    document.getElementById("btn-clear").addEventListener("click", () => {
      if (!safeEnabled) return;
      poses.length = 0;
      poseCounter = 0;
      renderPoses();
      stopPlayback();
    });

    /* ============ Playback (joint-space / articulate) ============ */
    function stopPlayback() {
      isPlaying = false;
      if (playTimeout) {
        clearTimeout(playTimeout);
        playTimeout = null;
      }
    }

    function playSequence(index = 0) {
      if (!isPlaying || !safeEnabled) return;
      if (poses.length === 0) return;

      const speed = parseFloat(document.getElementById("speed-range").value) || 1.0;
      const baseDelay = 40; // ms per interpolation step
      const delay = baseDelay / speed;

      const currentPose = poses[index];
      const nextPose = poses[(index + 1) % poses.length];

      const steps = 25;
      let step = 0;

      function stepInterp() {
        if (!isPlaying || !safeEnabled) return;
        const s = step / steps;
        j1 = currentPose.j1 + (nextPose.j1 - currentPose.j1) * s;
        j2 = currentPose.j2 + (nextPose.j2 - currentPose.j2) * s;
        j3 = currentPose.j3 + (nextPose.j3 - currentPose.j3) * s;
        drawRobot();
        step++;
        if (step <= steps) {
          playTimeout = setTimeout(stepInterp, delay);
        } else {
          const nextIndex = (index + 1) % poses.length;
          playSequence(nextIndex);
        }
      }

      stepInterp();
    }

    document.getElementById("btn-play").addEventListener("click", () => {
      if (!safeEnabled) return;
      if (isPlaying) {
        stopPlayback();
        return;
      }
      if (poses.length === 0) return;
      isPlaying = true;
      playSequence(0);
    });

    document.getElementById("speed-range").addEventListener("input", () => {
      if (isPlaying) {
        stopPlayback();
        isPlaying = true;
        playSequence(0);
      }
    });

    /* ============ Init ============ */
    setJogMode("joint");
    drawRobot();
    renderPoses();
  </script>
</body>
</html>
